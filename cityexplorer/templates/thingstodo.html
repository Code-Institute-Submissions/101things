{% extends 'layout.html' %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">

        <main class="col-md-8 mr-4 content-section container">
            <a href="{{url_for('index')}}" class="dark-gold"><i class="fas fa-arrow-circle-left"></i>Return to Home</a>
            <div class="d-flex align-items-end">
                <h1 class="dark-gold">101 Things to do in {{ city['location'] }}</h1>
                {% if current_user.is_authenticated %}
                <button class="btn submit-btn ml-auto d-inline-block"> <a
                        href="{{ url_for('add_suggestion', location=city['location']) }}">Add
                        Suggestion
                    </a>
                </button>
                {% endif %}
            </div>
            <img class="w-100 title-img" src="{{ city['bg_img'] }}">
            <div class="pl-0 py-2">
                <!-- Suggestion List  -->
                {% for thing in things %}
                <div class="accordion thingtodo" id="thingtodo">
                    <a href="#" id="heading{{ loop.index }}" class="text-left collapsed" data-toggle="collapse"
                        data-target="#collapse{{ loop.index }}" aria-expanded="true" aria-controls="collapseOne">
                        <div class="suggestion-item py-2">
                            <div class="d-inline pr-2">{{ loop.index + (page - 1) * per_page }}.</div>
                            <p class="d-inline">{{ thing['suggestion'] }}</p>
                        </div>
                    </a>

                    <!-- Collapsed content  -->
                    <div id="collapse{{ loop.index }}" class="collapse pl-4 py-2 mb-4 thing-grid"
                        aria-labelledby="heading{{ loop.index }}" data-parent="#thingtodo">
                        <ul class="thing-icons pr-3">
                            <li>
                                <i class="fas fa-tag light-gold"></i>
                                <p>{{ thing['category'] }}</p>
                            </li>
                            <li>
                                <i class="fas fa-money-bill-wave light-gold"></i>
                                <p>{{ thing['cost'] }}</p>
                            </li>
                            <li>
                                <i id="icon-url" class="fas fa-link light-gold"></i>
                                <p><a href="{{ thing['url'] }}" target="_blank"> Visit website</a></p>
                            </li>
                        </ul>
                        <div class="thing-comment">

                            <div class="col-12">
                                <i class="fas fa-quote-left light-blue fa-lg"></i>
                                {{ thing['comment'] }}
                                <i class="fas fa-quote-right light-blue fa-lg"></i>
                            </div>
                        </div>
                        <div class="author">
                            <img class="rounded-circle" src="{{ thing['profile'] }}">
                            <small>Suggested by <b>{{ thing['author'] }}</b></small>
                            <div class="d-flex">
                                
                                    <a href="#"><i class="fas fa-edit"></i></i>Edit</a>
                                
                                
                                    <a href="#"><i class="fas fa-trash-alt"></i>Delete</a>
                                
                            </div>
                        </div>
                    </div>

                </div>
                {% endfor %}
            </div>
            {{ pagination.info }}
            {{ pagination.links }}

        </main>

        <!-- Feature to filter results  -->
        <aside class="col-md-3 p-4">
            <h3>Filters:</h3>
            <!-- If filters in place, the filters are listed -->
            {% if filters|length > 0 %}
            <ul id="filtersList">
                {% for filt in filters %}
                <li>{{ filt }}</li>
                {% endfor %}
            </ul>
            <a href="{{url_for('suggestion_list', city=city['location']) }}" id="clearFilter"><i
                    class="fas fa-times-circle"></i>Clear filters</a>
            {% endif %}

            <!-- Filter form -->
            <form method="GET" action="{{ url_for('suggestion_list', city=city['location']) }}" id="filterForm">
                <fieldset class="form-group m-0">
                    <div class="form-group px-3 py-2">
                        <b>{{ form.category.label(class="form-control-label") }}</b>
                        <table id="categories" class="filterOptions mb-2">
                            {% for subfield in form.category %}
                            <tr>
                                <td>{{ subfield }}</td>
                                <td>{{ subfield.label }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                        <a href="#" id="loadMore"><i class="fas fa-arrow-circle-down"></i>Load
                            more</a>
                        <a href="#" id="showLess"><i class="fas fa-arrow-circle-up"></i>Show less</a>
                    </div>

                    <div class="form-group px-3 py-2">
                        <b>{{ form.cost.label(class="form-control-label") }}</b>
                        <table class="filterOptions">
                            {% for subfield in form.cost %}
                            <tr>
                                <td>{{ subfield }}</td>
                                <td>{{ subfield.label }}</td>
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </fieldset>

            </form>
        </aside>


    </div>
</div>

<script>
    $(document).ready(function () {
        // Takes the 'filters' variable passed from the view and converts it from a list type to a json array.
        // Loops through the array and uses the value on each iteration in a jquery selector, to identify the checkbox (input) with matching value.
        // Sets the identified input to 'checked'

        let filterarray = {{ filters | tojson }};
        $.each(filterarray, function (index, value) {
            $("input[value='" + value + "']").attr("checked", "checked");
        });

        // Limits the number of table rows 'shown' to 5.
        // When Load More link is clicked, the limit is extended to show full table
        // Link is hidden and Show Less link is shownn

        total_tr = $("#categories tr").length;
        let limit = 5;
        $('#categories tr:lt(' + limit + ')').show();
        $('#loadMore').click(function () {
            // variablename = (condition) ? value1:value2
            limit = total_tr;
            $('#categories tr:lt(' + limit + ')').slideDown(300, "swing", function () {
                $('#showLess').show()
                $('#loadMore').hide()
            });
        });

        // When Show Less link is clicked, limit is returned to value of 5
        // Any table rows excluded from the first 5 rows in the table are hidden

        $('#showLess').click(function () {
            limit = 5;
            $('#categories tr').not(':lt(' + limit + ')').slideUp(300, "swing", function () {
                $('#showLess').hide()
                $('#loadMore').show()
            });
        });
    });


    // Whenever a checkbox is checked (input provided), the form is submiited

    $("form input").change(function () {
        $(this).closest('form').submit();
    });
</script>
{% endblock content %}